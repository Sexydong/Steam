<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì •ë³´ë³´ì•ˆ ì±Œë¦°ì§€ (ë­í‚¹ ê¸°ëŠ¥)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }
        .answer-btn.correct {
            background-color: #22c55e !important; /* green-500 */
            color: white;
            border-color: #16a34a; /* green-600 */
        }
        .answer-btn.incorrect {
            background-color: #ef4444 !important; /* red-500 */
            color: white;
            border-color: #dc2626; /* red-600 */
        }
        .modal-backdrop {
            background-color: rgba(0,0,0,0.75);
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center justify-center min-h-screen p-4">

    <!-- User Info Modal -->
    <div id="user-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center z-50">
        <div class="bg-white text-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-sm transform transition-all">
            <h2 class="text-2xl font-bold mb-6 text-center text-gray-700">ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”</h2>
            <form id="user-form">
                <div class="mb-4">
                    <label for="grade" class="block text-sm font-medium text-gray-600 mb-1">í•™ë…„</label>
                    <input type="number" id="grade" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" required>
                </div>
                <div class="mb-4">
                    <label for="classNum" class="block text-sm font-medium text-gray-600 mb-1">ë°˜</label>
                    <input type="number" id="classNum" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" required>
                </div>
                <div class="mb-4">
                    <label for="studentNum" class="block text-sm font-medium text-gray-600 mb-1">ë²ˆí˜¸</label>
                    <input type="number" id="studentNum" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" required>
                </div>
                <div class="mb-6">
                    <label for="name" class="block text-sm font-medium text-gray-600 mb-1">ì´ë¦„</label>
                    <input type="text" id="name" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" required>
                </div>
                <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-300 transition duration-300">ì±Œë¦°ì§€ ì‹œì‘!</button>
            </form>
        </div>
    </div>

    <div id="main-content" class="w-full max-w-7xl mx-auto hidden">
        <h1 class="text-4xl font-bold text-center mb-2 text-indigo-400">ğŸ›¡ï¸ ì •ë³´ë³´ì•ˆ ì±Œë¦°ì§€ ğŸ›¡ï¸</h1>
        <p id="welcome-message" class="text-center text-gray-400 mb-8"></p>
        
        <div class="flex flex-col lg:flex-row gap-8">
            <!-- Quiz Container -->
            <div id="quiz-container" class="bg-gray-800 p-8 rounded-2xl shadow-lg w-full lg:w-2/3">
                <div id="question-container" class="mb-6">
                    <div class="flex justify-between items-center mb-4">
                         <h2 id="question-number" class="text-xl font-bold text-indigo-300">ë¬¸ì œ 1</h2>
                         <div class="text-lg font-semibold text-yellow-400">ì ìˆ˜: <span id="score">0</span></div>
                    </div>
                    <p id="question-element" class="text-2xl leading-relaxed min-h-[6rem]">ì§ˆë¬¸ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
                </div>
                <div id="answer-buttons" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Answer buttons will be generated here -->
                </div>
                <div class="mt-8 flex justify-end">
                    <button id="next-btn" class="bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-300 transition duration-300 hidden">ë‹¤ìŒ ë¬¸ì œ</button>
                </div>
            </div>

            <!-- Ranking Board -->
            <div class="w-full lg:w-1/3 bg-gray-800 p-6 rounded-2xl shadow-lg">
                <h2 class="text-3xl font-bold mb-6 text-center text-yellow-400">ğŸ† ì‹¤ì‹œê°„ ë­í‚¹ ğŸ†</h2>
                <div class="overflow-y-auto max-h-[500px]">
                    <table class="w-full text-sm text-left text-gray-400">
                        <thead class="text-xs text-gray-300 uppercase bg-gray-700">
                            <tr>
                                <th scope="col" class="px-4 py-3">ìˆœìœ„</th>
                                <th scope="col" class="px-4 py-3">ì •ë³´</th>
                                <th scope="col" class="px-4 py-3">ì´ë¦„</th>
                                <th scope="col" class="px-4 py-3 text-right">ì ìˆ˜</th>
                            </tr>
                        </thead>
                        <tbody id="ranking-body">
                            <!-- Ranking data will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>


    <script type="module">
        // Firebase 11.6.1 imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, limit, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURATION ---
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'security-challenge-game';
        
        // --- FIREBASE INITIALIZATION ---
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Firebase initialization failed:", e);
            document.body.innerHTML = "Firebase ì„¤ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.";
        }
        
        // --- DOM ELEMENTS ---
        const userModal = document.getElementById('user-modal');
        const userForm = document.getElementById('user-form');
        const mainContent = document.getElementById('main-content');
        const welcomeMessage = document.getElementById('welcome-message');
        const quizContainer = document.getElementById('quiz-container');
        const questionContainer = document.getElementById('question-container');
        const questionElement = document.getElementById('question-element');
        const questionNumberEl = document.getElementById('question-number');
        const answerButtons = document.getElementById('answer-buttons');
        const nextBtn = document.getElementById('next-btn');
        const scoreEl = document.getElementById('score');
        const rankingBody = document.getElementById('ranking-body');

        // --- QUIZ QUESTIONS ---
        const questions = [
            {
                question: "ë‹¤ë¥¸ ì‚¬ëŒì˜ ê°œì¸ì •ë³´ë¥¼ ë¬´ë‹¨ìœ¼ë¡œ ì´ìš©í•˜ëŠ” í–‰ìœ„ë¥¼ ë¬´ì—‡ì´ë¼ê³  í• ê¹Œìš”?",
                answers: [
                    { text: "í•´í‚¹", correct: false },
                    { text: "ê°œì¸ì •ë³´ ì¹¨í•´", correct: true },
                    { text: "í”¼ì‹±", correct: false },
                    { text: "ìŠ¤ë¯¸ì‹±", correct: false }
                ]
            },
            {
                question: "ì›¹ì‚¬ì´íŠ¸ ë¹„ë°€ë²ˆí˜¸ ì„¤ì • ì‹œ ê°€ì¥ ì•ˆì „í•œ ë°©ë²•ì€ ë¬´ì—‡ì¼ê¹Œìš”?",
                answers: [
                    { text: "ìƒì¼ì´ë‚˜ ì „í™”ë²ˆí˜¸ ì‚¬ìš©", correct: false },
                    { text: "ëª¨ë“  ì‚¬ì´íŠ¸ì— ë™ì¼í•œ ë¹„ë°€ë²ˆí˜¸ ì‚¬ìš©", correct: false },
                    { text: "ì˜ë¬¸, ìˆ«ì, íŠ¹ìˆ˜ë¬¸ìë¥¼ ì¡°í•©í•˜ì—¬ 8ìë¦¬ ì´ìƒìœ¼ë¡œ ì„¤ì •", correct: true },
                    { text: "ìì£¼ ì‚¬ìš©í•˜ëŠ” ë‹¨ì–´ ì‚¬ìš©", correct: false }
                ]
            },
            {
                question: "ì¶œì²˜ê°€ ë¶ˆë¶„ëª…í•œ ì´ë©”ì¼ì— í¬í•¨ëœ ì²¨ë¶€íŒŒì¼ì´ë‚˜ ë§í¬ë¥¼ í´ë¦­í–ˆì„ ë•Œ ë°œìƒí•  ìˆ˜ ìˆëŠ” ê°€ì¥ í° ìœ„í˜‘ì€?",
                answers: [
                    { text: "ì»´í“¨í„° ì†ë„ ì €í•˜", correct: false },
                    { text: "ì•…ì„±ì½”ë“œ ê°ì—¼", correct: true },
                    { text: "ì¸í„°ë„· ì—°ê²° ëŠê¹€", correct: false },
                    { text: "ëª¨ë‹ˆí„° í™”ë©´ ë°ê¸° ë³€ê²½", correct: false }
                ]
            },
            {
                question: "ê¸ˆìœµê¸°ê´€ì„ ì‚¬ì¹­í•˜ì—¬ ê°œì¸ì˜ ê¸ˆìœµì •ë³´ë¥¼ ë¹¼ë‚´ëŠ” ì‚¬ê¸° ìˆ˜ë²•ì„ ë¬´ì—‡ì´ë¼ê³  í• ê¹Œìš”?",
                answers: [
                    { text: "íŒŒë°", correct: false },
                    { text: "ìŠ¤ë‹ˆí•‘", correct: false },
                    { text: "í”¼ì‹±(Phishing)", correct: true },
                    { text: "ìŠ¤í‘¸í•‘", correct: false }
                ]
            },
            {
                question: "ê³µê³µì¥ì†Œì—ì„œ ë¬´ë£Œ ì™€ì´íŒŒì´(Wi-Fi) ì‚¬ìš© ì‹œ ì£¼ì˜í•´ì•¼ í•  ì ìœ¼ë¡œ ì˜¬ë°”ë¥´ì§€ ì•Šì€ ê²ƒì€?",
                answers: [
                    { text: "ë³´ì•ˆ ì„¤ì •ì´ ì—†ëŠ” ì™€ì´íŒŒì´ëŠ” ì‚¬ìš©ì„ ìì œí•œë‹¤.", correct: false },
                    { text: "ì¤‘ìš”í•œ ê°œì¸ì •ë³´ë‚˜ ê¸ˆìœµ ê±°ë˜ëŠ” í•˜ì§€ ì•ŠëŠ”ë‹¤.", correct: false },
                    { text: "ë¬´ë£Œì´ë¯€ë¡œ ë§ˆìŒê» ëª¨ë“  ì‚¬ì´íŠ¸ì— ì ‘ì†í•´ë„ ì•ˆì „í•˜ë‹¤.", correct: true },
                    { text: "VPN(ê°€ìƒì‚¬ì„¤ë§)ì„ ì´ìš©í•˜ì—¬ í†µì‹ ì„ ì•”í˜¸í™”í•œë‹¤.", correct: false }
                ]
            }
        ];

        // --- GAME STATE ---
        let currentUser = { grade: '', classNum: '', studentNum: '', name: '' };
        let currentQuestionIndex = 0;
        let score = 0;
        
        // --- AUTHENTICATION ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                console.log("Authenticated user:", user.uid);
            } else {
                 try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Authentication failed:", error);
                }
            }
        });

        // --- RANKING LOGIC ---
        const rankingsCol = collection(db, `artifacts/${appId}/public/data/rankings`);
        const q = query(rankingsCol, orderBy("score", "desc"), limit(20));

        onSnapshot(q, (snapshot) => {
            rankingBody.innerHTML = '';
            if (snapshot.empty) {
                rankingBody.innerHTML = '<tr><td colspan="4" class="text-center py-4">ì•„ì§ ë­í‚¹ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }
            snapshot.docs.forEach((doc, index) => {
                const data = doc.data();
                const rank = index + 1;
                const rankEmoji = rank === 1 ? 'ğŸ¥‡' : rank === 2 ? 'ğŸ¥ˆ' : rank === 3 ? 'ğŸ¥‰' : '';
                const info = `${data.grade}í•™ë…„ ${data.classNum}ë°˜ ${data.studentNum}ë²ˆ`;
                
                const row = document.createElement('tr');
                row.className = 'bg-gray-800 border-b border-gray-700 hover:bg-gray-600';
                row.innerHTML = `
                    <td class="px-4 py-3 font-medium">${rankEmoji} ${rank}</td>
                    <td class="px-4 py-3">${info}</td>
                    <td class="px-4 py-3 font-semibold">${data.name}</td>
                    <td class="px-4 py-3 text-right font-bold text-yellow-300">${data.score}</td>
                `;
                rankingBody.appendChild(row);
            });
        }, (error) => {
            console.error("Error fetching rankings:", error);
            rankingBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-red-500">ë­í‚¹ ë¡œë”© ì‹¤íŒ¨</td></tr>';
        });

        // --- GAME LOGIC ---
        userForm.addEventListener('submit', (e) => {
            e.preventDefault();
            currentUser.grade = document.getElementById('grade').value;
            currentUser.classNum = document.getElementById('classNum').value;
            currentUser.studentNum = document.getElementById('studentNum').value;
            currentUser.name = document.getElementById('name').value.trim();

            if (currentUser.name) {
                userModal.classList.add('hidden');
                mainContent.classList.remove('hidden');
                welcomeMessage.textContent = `${currentUser.grade}í•™ë…„ ${currentUser.classNum}ë°˜ ${currentUser.name}ë‹˜, ë„ì „ì„ ì‹œì‘í•©ë‹ˆë‹¤!`;
                startQuiz();
            }
        });

        function startQuiz() {
            currentQuestionIndex = 0;
            score = 0;
            scoreEl.innerText = score;
            nextBtn.classList.add('hidden');
            displayQuestion();
        }

        function displayQuestion() {
            resetState();
            let currentQuestion = questions[currentQuestionIndex];
            let questionNo = currentQuestionIndex + 1;
            questionNumberEl.innerText = `ë¬¸ì œ ${questionNo}`;
            questionElement.innerText = currentQuestion.question;

            currentQuestion.answers.forEach(answer => {
                const button = document.createElement("button");
                button.innerHTML = answer.text;
                button.classList.add("answer-btn", "w-full", "text-left", "p-4", "rounded-lg", "border-2", "border-gray-500", "hover:bg-gray-700", "transition", "duration-200");
                answerButtons.appendChild(button);
                if (answer.correct) {
                    button.dataset.correct = answer.correct;
                }
                button.addEventListener("click", selectAnswer);
            });
        }

        function resetState() {
            nextBtn.classList.add('hidden');
            while (answerButtons.firstChild) {
                answerButtons.removeChild(answerButtons.firstChild);
            }
        }

        function selectAnswer(e) {
            const selectedBtn = e.target;
            const isCorrect = selectedBtn.dataset.correct === "true";
            if (isCorrect) {
                selectedBtn.classList.add("correct");
                score += 10;
                scoreEl.innerText = score;
            } else {
                selectedBtn.classList.add("incorrect");
            }
            Array.from(answerButtons.children).forEach(button => {
                if (button.dataset.correct === "true") {
                    if(!button.classList.contains('correct')) button.classList.add("correct");
                }
                button.disabled = true;
            });
            nextBtn.classList.remove('hidden');
        }

        async function showResults() {
            resetState();
            questionElement.innerHTML = `ì±Œë¦°ì§€ ì¢…ë£Œ! <br>ì´ <span class="text-yellow-400 font-bold">${questions.length}</span>ë¬¸ì œ ì¤‘ <span class="text-green-400 font-bold">${score / 10}</span>ë¬¸ì œë¥¼ ë§í˜”ìŠµë‹ˆë‹¤. <br>ìµœì¢… ì ìˆ˜ëŠ” <span class="text-indigo-400 font-bold">${score}</span>ì  ì…ë‹ˆë‹¤.`;
            questionNumberEl.innerText = "ê²°ê³¼";
            nextBtn.innerHTML = "ë‹¤ì‹œ ì‹œì‘";
            nextBtn.classList.remove('hidden');

            questionElement.innerHTML += `<br><br>ë­í‚¹ì— ì ìˆ˜ë¥¼ ë“±ë¡í•˜ê³  ìˆìŠµë‹ˆë‹¤...`;
            try {
                await addDoc(rankingsCol, {
                    ...currentUser,
                    score: score,
                    createdAt: serverTimestamp()
                });
                questionElement.innerHTML = questionElement.innerHTML.replace("ë­í‚¹ì— ì ìˆ˜ë¥¼ ë“±ë¡í•˜ê³  ìˆìŠµë‹ˆë‹¤...", "<span class='text-green-400'>ë­í‚¹ ë“±ë¡ ì™„ë£Œ!</span>");
            } catch (error) {
                console.error("Error adding document: ", error);
                questionElement.innerHTML = questionElement.innerHTML.replace("ë­í‚¹ì— ì ìˆ˜ë¥¼ ë“±ë¡í•˜ê³  ìˆìŠµë‹ˆë‹¤...", "<span class='text-red-500'>ë­í‚¹ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</span>");
            }
        }

        function handleNextButton() {
            currentQuestionIndex++;
            if (currentQuestionIndex < questions.length) {
                displayQuestion();
            } else {
                showResults();
            }
        }

        nextBtn.addEventListener("click", () => {
            if (currentQuestionIndex < questions.length) {
                handleNextButton();
            } else {
                // Restart logic: simply reload the page to force re-entry of info
                window.location.reload();
            }
        });

    </script>
</body>
</html>

